# Редирект HTTP на HTTPS
<VirtualHost *:80>
    ServerName videoeditor.1tlt.ru
    ServerAlias www.videoeditor.1tlt.ru
    
    # Редирект на HTTPS
    RewriteEngine on
    RewriteCond %{SERVER_NAME} =www.videoeditor.1tlt.ru [OR]
    RewriteCond %{SERVER_NAME} =videoeditor.1tlt.ru
    RewriteRule ^ https://%{SERVER_NAME}%{REQUEST_URI} [END,NE,R=permanent]
</VirtualHost>

# HTTPS VirtualHost
<VirtualHost *:443>
    ServerName videoeditor.1tlt.ru
    ServerAlias www.videoeditor.1tlt.ru
    
    DocumentRoot /ssd/www/videoeditor/public
    
    # SSL сертификат от Let's Encrypt
    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/videoeditor.1tlt.ru/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/videoeditor.1tlt.ru/privkey.pem
    Include /etc/letsencrypt/options-ssl-apache.conf
    
    # Современные SSL настройки (опционально, если не включены в options-ssl-apache.conf)
    # SSLProtocol all -SSLv3 -TLSv1 -TLSv1.1
    # SSLCipherSuite ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
    # SSLHonorCipherOrder off
    # SSLSessionTickets off
    
    <Directory /ssd/www/videoeditor/public>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
        
        # FallbackResource для маршрутизации (работает даже без mod_rewrite)
        # Все несуществующие файлы будут перенаправлены на index.php
        FallbackResource /index.php
        
        # PHP-FPM через mod_proxy_fcgi
        <FilesMatch \.php$>
            SetHandler "proxy:fcgi://127.0.0.1:9000"
        </FilesMatch>
    </Directory>
    
    ErrorLog ${APACHE_LOG_DIR}/videoeditor_ssl_error.log
    CustomLog ${APACHE_LOG_DIR}/videoeditor_ssl_access.log combined
    
    # Защита от прямого доступа к конфигурационным файлам
    <FilesMatch "\.(htaccess|htpasswd|ini|log|sh|sql|md)$">
        Require all denied
    </FilesMatch>
    
    # Максимальный размер загружаемых файлов
    LimitRequestBody 104857600
    
    # PHP настройки (для PHP-FPM настройте в php.ini или pool.d/www.conf)
    # php_value upload_max_filesize 100M
    # php_value post_max_size 100M
    # php_value max_execution_time 300
    # php_value memory_limit 512M
</VirtualHost>
