# Заметки по безопасности

## Аутентификация и авторизация

1. **Хеширование паролей**: Использует `password_hash()` PHP с bcrypt (алгоритм по умолчанию)
2. **Безопасность сессий**: 
   - ID сессий регенерируются при входе
   - Сессии хранятся в базе данных для отслеживания
   - Время жизни сессии: 2 часа (настраивается)
3. **Контроль доступа на основе ролей**: Роли администратора и пользователя применяются через middleware
4. **Защита от CSRF**: Должна быть реализована для всех POST запросов (рекомендуется: добавить CSRF токены)

## Безопасность загрузки файлов

1. **Валидация типа файла**: Принимаются только разрешенные форматы видео
2. **Лимиты размера файла**: Применяются на уровне приложения и сервера (Nginx)
3. **Защита от обхода путей**: Пути к файлам очищены, нет пользовательского ввода в путях
4. **Изоляция хранилища**: Загрузки хранятся вне корня веб-сервера
5. **Валидация содержимого файла**: Рекомендуется добавить проверку MIME типа

## Безопасность базы данных

1. **Подготовленные запросы**: Все запросы используют подготовленные запросы PDO
2. **SQL инъекции**: Защищено через параметризованные запросы
3. **Пользователь БД**: Ограниченные привилегии (только к базе данных приложения)
4. **Безопасность подключения**: Рекомендуется использовать SSL для подключений MySQL в продакшене

## Валидация ввода

1. **Валидация email**: Базовая проверка формата email
2. **Требования к паролю**: Минимум 8 символов (настраивается)
3. **Валидация загрузки файлов**: Проверка типа, размера и ошибок
4. **Защита от XSS**: Вывод экранирован в представлениях с использованием `htmlspecialchars()`

## Безопасность сервера

1. **Конфигурация Nginx**: 
   - Блокирует доступ к чувствительным директориям
   - Ограничивает размер загрузки
   - Включены заголовки безопасности
2. **Конфигурация PHP**: 
   - `display_errors` должен быть выключен в продакшене
   - `expose_php` должен быть выключен
   - Настроены лимиты загрузки файлов
3. **Права доступа к файлам**: 
   - Директории хранилища: 775 (www-data:www-data)
   - Файлы приложения: 755
   - Файлы конфигурации: 600 (не должны быть в корне веб-сервера)

## Рекомендации для продакшена

1. **HTTPS**: Принудительно используйте HTTPS для всех подключений
2. **Ограничение скорости**: Реализуйте ограничение скорости для API endpoints
3. **Логирование**: Мониторьте неудачные попытки входа, подозрительную активность
4. **Резервное копирование**: Регулярное резервное копирование базы данных и файлов
5. **Обновления**: Поддерживайте актуальными PHP, MySQL, Nginx и FFmpeg
6. **Файрвол**: Настройте UFW или iptables
7. **SSH**: Отключите вход root, используйте аутентификацию по ключам
8. **Переменные окружения**: Переместите чувствительную конфигурацию в переменные окружения
9. **CSRF токены**: Реализуйте защиту от CSRF для форм
10. **Политика безопасности контента**: Добавьте заголовки CSP
11. **Двухфакторная аутентификация**: Рассмотрите добавление 2FA для учетных записей администратора
12. **Аудит логирование**: Логируйте все действия администратора

## Безопасность воркера

1. **Изоляция процесса**: Воркер запускается как пользователь www-data
2. **Лимиты ресурсов**: Установлены лимиты памяти и дескрипторов файлов
3. **Обработка ошибок**: Сбои логируются, задачи повторяются с лимитами
4. **Защита от таймаута**: Задачи таймаутятся после настроенной длительности

## Известные ограничения

- Нет реализации CSRF токенов (должна быть добавлена)
- Нет ограничения скорости (должно быть добавлено)
- Базовая валидация файлов (рекомендуется добавить сканирование на вирусы)
- Нет белого списка IP для администратора (рекомендуется добавить)
- Защита от фиксации сессии может быть улучшена
