# Платформа обработки видео - Архитектура

## Архитектура системы

### Общий обзор
```
┌─────────────┐     ┌──────────────┐     ┌─────────────┐
│   Nginx     │────▶│   PHP-FPM    │────▶│   MySQL     │
│  (Порт 80)  │     │  (Порт 9000) │     │  (Порт 3306)│
└─────────────┘     └──────────────┘     └─────────────┘
                            │
                            ▼
                    ┌──────────────┐
                    │   FFmpeg     │
                    │  (Локальный) │
                    └──────────────┘
                            │
                            ▼
                    ┌──────────────┐
                    │ Воркер очереди│
                    │  (systemd)    │
                    └──────────────┘
```

### Технологический стек
- **Backend**: PHP 8.1+ (Объектно-ориентированный, PSR-4 автозагрузка)
- **База данных**: MySQL 8.0+
- **Веб-сервер**: Nginx + PHP-FPM
- **Обработка видео**: FFmpeg (на стороне сервера)
- **Система очередей**: Очередь задач на основе MySQL с CLI воркером
- **Аутентификация**: На основе сессий с системой ролей
- **Хранилище**: Локальная файловая система (расширяемо до S3)

### Структура директорий
```
/
├── app/
│   ├── Controllers/      # Обработчики запросов
│   ├── Models/          # Модели базы данных
│   ├── Services/        # Бизнес-логика
│   ├── Middleware/      # Аутентификация, валидация
│   ├── Core/            # Базовые классы, конфигурация
│   └── Helpers/         # Вспомогательные функции
├── public/              # Корень веб-сервера (корень документа Nginx)
│   ├── index.php        # Точка входа
│   ├── assets/          # CSS, JS, изображения
│   └── uploads/         # Загрузки пользователей (символическая ссылка)
├── storage/
│   ├── uploads/         # Оригинальные видео
│   ├── renders/         # Обработанные видео
│   ├── logs/            # Логи приложения
│   └── cache/           # Временные файлы
├── config/              # Файлы конфигурации
├── database/            # SQL миграции
├── scripts/             # Скрипты развертывания, воркеры
├── tests/               # Модульные тесты (опционально)
└── vendor/              # Зависимости Composer
```

### Поток запросов
1. **Запрос пользователя** → Nginx → `public/index.php`
2. **Роутер** → Парсит URL, определяет контроллер/действие
3. **Middleware** → Аутентификация, валидация
4. **Контроллер** → Обрабатывает запрос, вызывает сервисы
5. **Сервис** → Бизнес-логика, операции с БД
6. **Модель** → Абстракция базы данных
7. **Ответ** → JSON или HTML шаблон

### Поток обработки видео
1. **Загрузка** → Файл проверен, сохранен в `storage/uploads/`
2. **Создание задачи** → Запись вставлена в таблицу `render_jobs`
3. **Очередь** → Воркер берет задачу (статус: `pending`)
4. **Обработка** → FFmpeg рендерит видео с наложениями
5. **Завершение** → Вывод сохранен в `storage/renders/`
6. **Уведомление** → Пользователь уведомлен, статус задачи обновлен

### Система очередей
- **Хранилище**: Таблица MySQL `render_jobs`
- **Воркер**: CLI PHP скрипт (`scripts/worker.php`)
- **Процесс**: systemd сервис запускает воркер непрерывно
- **Блокировка**: Блокировка на уровне строк БД предотвращает дублирование обработки
- **Повторы**: Автоматический повтор при сбое (макс. 3 попытки)

### Уровни безопасности
1. **Аутентификация**: На основе сессий с защищенными куками
2. **Авторизация**: Контроль доступа на основе ролей (admin/user)
3. **Валидация файлов**: Проверка типа, размера, содержимого
4. **SQL инъекции**: Только подготовленные запросы
5. **Защита от XSS**: Экранирование вывода
6. **Защита от CSRF**: Валидация токенов
7. **Обход путей**: Очищенные пути к файлам
8. **Ограничение скорости**: Лимиты загрузки на пользователя

### Дизайн базы данных
- **Нормализована**: Соответствие 3NF
- **Индексы**: Оптимизированы для частых запросов
- **Внешние ключи**: Референциальная целостность
- **Мягкое удаление**: Сохранение истории данных

### Стратегия развертывания
- **На основе Git**: Push в main запускает развертывание
- **Без простоя**: Паттерн blue-green развертывания
- **Сохранение воркера**: Воркеры продолжают работать во время развертывания
- **Откат**: Git revert + повторное развертывание

### Соображения масштабируемости
- **Горизонтальное масштабирование**: Возможны несколько воркеров
- **Хранилище**: Можно мигрировать на S3/Object Storage
- **Очередь**: Можно мигрировать на Redis/RabbitMQ
- **Кэширование**: Готово к интеграции Redis
- **CDN**: Статические ресурсы могут обслуживаться через CDN
